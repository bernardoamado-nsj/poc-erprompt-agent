{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "planner.schema.json",
  "title": "erprompt-lib Planner Output",
  "description": "Schema describing the JSON output produced by the Planner. The Planner decomposes a PO functional specification into entity-generation tasks and layout-generation tasks.",
  "type": "object",
  "additionalProperties": false,
  "required": ["escopo_padrao", "entities", "layouts", "decisoes"],
  "properties": {
    "escopo_padrao": {
      "type": "string",
      "description": "Default scope (namespace). The planner should infer the best scope; if it cannot infer, it should use 'geral'.",
      "minLength": 1,
      "default": "geral"
    },
    "entities": {
      "type": "array",
      "description": "List of entities to generate (one JSON per entity via the entity generator).",
      "minItems": 1,
      "items": { "$ref": "#/definitions/plannerEntityTask" }
    },
    "layouts": {
      "type": "array",
      "description": "List of layouts (screens) to generate (one JSON per layout via the layout generator).",
      "minItems": 1,
      "items": { "$ref": "#/definitions/plannerLayoutTask" }
    },
    "decisoes": {
      "$ref": "#/definitions/plannerDecisions"
    }
  },
  "definitions": {
    "scope": {
      "type": "string",
      "description": "Logical scope/namespace. If unknown, use 'geral'.",
      "minLength": 1,
      "default": "geral"
    },
    "entityCode": {
      "type": "string",
      "description": "Entity code (PascalCase recommended).",
      "minLength": 1,
      "pattern": "^[A-Z][A-Za-z0-9]*$"
    },
    "layoutCode": {
      "type": "string",
      "description": "Layout code (kebab-case recommended). Example: 'list-nfes', 'edit-nfe', 'view-nfe'.",
      "minLength": 1,
      "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$"
    },
    "schemaRef": {
      "type": "string",
      "description": "Reference to an entity schema in the form '<escopo>/<CodigoEntidade>'. Example: 'fiscal/Nfe'.",
      "minLength": 3,
      "pattern": "^[^/\\s]+\\/[A-Z][A-Za-z0-9]*$"
    },
    "alias": {
      "type": "string",
      "description": "Logical alias used in layout transaction.entities[].name and as dataRef in components.",
      "minLength": 1,
      "pattern": "^[a-z][a-z0-9_]*$"
    },
    "plannerEntityTask": {
      "type": "object",
      "additionalProperties": false,
      "required": ["escopo", "codigo", "descricao", "spec_markdown"],
      "properties": {
        "escopo": { "$ref": "#/definitions/scope" },
        "codigo": { "$ref": "#/definitions/entityCode" },
        "descricao": {
          "type": "string",
          "description": "Human-readable description of the entity.",
          "minLength": 1
        },
        "spec_markdown": {
          "type": "string",
          "description": "Markdown functional specification to be injected into the entity generator prompt ($spec). Must contain fields, required/optional hints, filters when explicitly requested, and any special rules.",
          "minLength": 1
        }
      }
    },
    "plannerLayoutTask": {
      "type": "object",
      "additionalProperties": false,
      "required": ["escopo", "codigo", "descricao", "spec_markdown", "entity_refs", "kind"],
      "properties": {
        "escopo": { "$ref": "#/definitions/scope" },
        "codigo": { "$ref": "#/definitions/layoutCode" },
        "descricao": {
          "type": "string",
          "description": "Human-readable description of the layout/screen.",
          "minLength": 1
        },
        "kind": {
          "type": "string",
          "description": "Screen intent. Used by the runner to enforce defaults (C = list + edit + detail) when the PO does not specify explicitly.",
          "enum": ["list", "edit", "detail"]
        },
        "spec_markdown": {
          "type": "string",
          "description": "Markdown functional specification to be injected into the layout generator prompt ($spec). The runner may append referenced entity JSON definitions after this spec.",
          "minLength": 1
        },
        "entity_refs": {
          "type": "array",
          "description": "Entity bindings required by the screen. This maps directly to layout.json_schema.transaction.entities[].",
          "minItems": 1,
          "items": { "$ref": "#/definitions/layoutEntityRef" }
        }
      }
    },
    "layoutEntityRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["alias", "schema", "cardinality", "load", "main"],
      "properties": {
        "alias": { "$ref": "#/definitions/alias" },
        "schema": { "$ref": "#/definitions/schemaRef" },
        "cardinality": {
          "type": "string",
          "description": "Data fetching cardinality. 'many' for list screens, 'one' for detail/edit screens (single selected record in context).",
          "enum": ["one", "many"]
        },
        "load": {
          "type": "boolean",
          "description": "Whether the screen should load data automatically.",
          "default": true
        },
        "main": {
          "type": "boolean",
          "description": "Marks the principal entity for this screen, when there are multiple bindings.",
          "default": false
        }
      }
    },

    "plannerOpenQuestion": {
      "type": "object",
      "additionalProperties": false,
      "required": ["question", "blocking", "default_assumption"],
      "properties": {
        "question": {
          "type": "string",
          "description": "Question for the user that affects modeling/layout materially.",
          "minLength": 1
        },
        "blocking": {
          "type": "boolean",
          "description": "If true, the runner should interrupt generation and request an answer (unless it explicitly applies default_assumption)."
        },
        "default_assumption": {
          "type": "string",
          "description": "Operational fallback if the user does not answer. Use empty string only when truly non-applicable.",
          "default": ""
        }
      }
    },

    "plannerDecisions": {
      "type": "object",
      "additionalProperties": false,
      "required": ["assumptions", "open_questions"],
      "properties": {
        "assumptions": {
          "type": "array",
          "description": "Non-blocking assumptions made by the planner when details are missing. Should be explicit and minimal.",
          "items": { "type": "string", "minLength": 1 },
          "default": []
        },
        "open_questions": {
          "type": "array",
          "description": "Questions that remain open; should be listed even if the planner proceeds with assumptions. Use blocking=true for questions that must be answered to proceed.",
          "items": { "$ref": "#/definitions/plannerOpenQuestion" },
          "default": []
        }
      }
    }
  }
}
