{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "entity.schema.json",
  "title": "erprompt-lib Entity Definition",
  "description": "Schema describing entity JSON files consumed by erprompt-lib (data modeling, filters and workflow).",
  "type": "object",
  "required": [
    "escopo",
    "codigo",
    "descricao",
    "json_schema"
  ],
  "additionalProperties": false,
  "properties": {
    "escopo": {
      "type": "string",
      "description": "Namespace of the entity (e.g., dados-mestre)."
    },
    "codigo": {
      "type": "string",
      "description": "Entity code inside the scope."
    },
    "descricao": {
      "type": "string",
      "description": "Human readable description."
    },
    "tenant": {
      "type": "integer"
    },
    "grupo_empresarial": {
      "type": "string"
    },
    "grupo_acesso": {
      "type": "string"
    },
    "created_by": {
      "type": "string"
    },
    "updated_by": {
      "type": "string"
    },
    "json_schema": {
      "$ref": "#/definitions/entityJsonSchema"
    }
  },
  "definitions": {
    "entityJsonSchema": {
      "type": "object",
      "required": [
        "$schema",
        "$id",
        "title",
        "type",
        "properties"
      ],
      "properties": {
        "$schema": {
          "type": "string"
        },
        "$id": {
          "type": "string"
        },
        "title": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": [
            "object"
          ]
        },
        "url": {
          "type": "string",
          "description": "Optional REST endpoint backing the entity."
        },
        "required": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "properties": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/fieldDefinition"
          }
        },
        "components": {
          "$ref": "#/definitions/componentsObject"
        },
        "filters": {
          "$ref": "#/definitions/filtersObject"
        },
        "workflowDefinition": {
          "$ref": "#/definitions/workflowDefinition"
        }
      },
      "additionalProperties": true
    },
    "fieldDefinition": {
      "type": "object",
      "properties": {
        "type": {
          "type": [
            "string",
            "array",
            "object",
            "number"
          ]
        },
        "format": {
          "type": "string",
          "description": "Custom format (date, datetime, currency, domain, etc.)."
        },
        "label": {
          "type": "string"
        },
        "pk": {
          "type": "boolean",
          "description": "Marks the field as primary key."
        },
        "defaultValue": {
          "description": "Default value for the field.",
          "type": [
            "string",
            "number",
            "boolean",
            "object",
            "array",
            "null"
          ]
        },
        "required": {
          "type": "boolean"
        },
        "minItems": {
          "type": "integer"
        },
        "items": {
          "anyOf": [
            {
              "$ref": "#/definitions/fieldDefinition"
            },
            {
              "$ref": "#/definitions/refDefinition"
            }
          ]
        },
        "$ref": {
          "type": "string",
          "description": "Reference to another schema definition."
        },
        "domainConfig": {
          "$ref": "#/definitions/domainConfig"
        },
        "dropdownConfig": {
          "type": "object",
          "additionalProperties": true
        },
        "properties": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/fieldDefinition"
          }
        }
      },
      "additionalProperties": true
    },
    "refDefinition": {
      "type": "object",
      "required": [
        "$ref"
      ],
      "properties": {
        "$ref": {
          "type": "string"
        }
      },
      "additionalProperties": true
    },
    "domainConfig": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "fixed",
            "dynamic",
            "internal"
          ]
        },
        "valueField": {
          "type": "string"
        },
        "labelFields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "labelSeparator": {
          "type": "string"
        },
        "$ref": {
          "type": "string",
          "description": "Reference to another entity when type is internal."
        },
        "items": {
          "type": "array",
          "items": {
            "type": "object"
          }
        },
        "url": {
          "type": "string"
        }
      },
      "additionalProperties": true
    },
    "componentsObject": {
      "type": "object",
      "properties": {
        "schemas": {
          "type": "object",
          "description": "Nested sub-schemas (reused objects/arrays).",
          "additionalProperties": {
            "$ref": "#/definitions/entityJsonSchema"
          }
        }
      },
      "additionalProperties": true
    },
    "filtersObject": {
      "type": "object",
      "properties": {
        "fields": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/filterField"
          }
        },
        "predicates": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/filterPredicate"
          }
        }
      },
      "additionalProperties": true
    },
    "filterField": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "description": "Filter component type (boolean, date, other entity, etc.)."
        },
        "label": {
          "type": "string"
        },
        "valueField": {
          "type": "string"
        },
        "labelFields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "sortable": {
          "type": "boolean"
        }
      },
      "additionalProperties": true
    },
    "filterPredicate": {
      "type": "object",
      "properties": {
        "label": {
          "type": "string"
        },
        "performanceTier": {
          "type": "string"
        },
        "exposedAs": {
          "type": "string"
        },
        "field": {
          "type": "string"
        },
        "operator": {
          "type": "string"
        },
        "params": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "type": {
                "type": "string"
              },
              "required": {
                "type": "boolean"
              }
            },
            "additionalProperties": true
          }
        },
        "expr": {
          "type": "object",
          "description": "JsonLogic expression."
        },
        "safeLimits": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "workflowDefinition": {
      "type": "object",
      "properties": {
        "workflowFor": {
          "type": "string"
        },
        "workflowStateField": {
          "type": "string"
        },
        "workflow_state_field": {
          "type": "string",
          "description": "Snake_case alias for workflowStateField."
        },
        "workflow": {
          "$ref": "#/definitions/workflowObject"
        },
        "ruleset": {
          "$ref": "#/definitions/ruleSet"
        }
      },
      "additionalProperties": true
    },
    "workflowObject": {
      "type": "object",
      "properties": {
        "initialState": {
          "type": "string"
        },
        "initial_state": {
          "type": "string",
          "description": "Snake_case alias for initialState."
        },
        "states": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/workflowState"
          }
        }
      },
      "additionalProperties": true
    },
    "workflowState": {
      "type": "object",
      "properties": {
        "label": {
          "type": "string"
        },
        "fieldValue": {
          "type": [
            "string",
            "boolean",
            "number"
          ]
        },
        "field_value": {
          "type": [
            "string",
            "boolean",
            "number"
          ],
          "description": "Snake_case alias for fieldValue."
        },
        "entityMode": {
          "type": "string",
          "enum": [
            "readonly",
            "readwrite"
          ]
        },
        "entity_mode": {
          "type": "string",
          "enum": [
            "readonly",
            "readwrite"
          ],
          "description": "Snake_case alias for entityMode."
        },
        "mainColor": {
          "type": "string"
        },
        "rules": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "transitions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/workflowTransition"
          }
        }
      },
      "additionalProperties": true
    },
    "workflowTransition": {
      "type": "object",
      "properties": {
        "targetState": {
          "type": "string"
        },
        "label": {
          "type": "string"
        },
        "transitionType": {
          "type": "string"
        },
        "buttonType": {
          "type": "string"
        },
        "rules": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": true
    },
    "ruleSet": {
      "type": "object",
      "properties": {
        "engine": {
          "type": "object",
          "properties": {
            "epsilon": {
              "type": "number"
            },
            "max_iterations": {
              "type": "integer"
            },
            "trace": {
              "type": "boolean"
            },
            "allow_cycles_with_pivot": {
              "type": "boolean"
            },
            "pivot_groups": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "fields": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "policy": {
                    "type": "string"
                  }
                },
                "additionalProperties": true
              }
            }
          },
          "additionalProperties": true
        },
        "rules": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/ruleDefinition"
          }
        }
      },
      "additionalProperties": true
    },
    "ruleDefinition": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "compute",
            "validation",
            "guard",
            "field_policy",
            "required_fields"
          ]
        },
        "id": {
          "type": "string"
        },
        "target": {
          "type": "string",
          "description": "Field (supports dotted path) affected by compute/field policy."
        },
        "expr": {
          "type": [
            "object",
            "array",
            "string",
            "number",
            "boolean"
          ],
          "description": "JsonLogic expression."
        },
        "depends_on": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "path": {
          "type": "string",
          "description": "Validation path."
        },
        "severity": {
          "type": "string",
          "enum": [
            "error",
            "warning"
          ]
        },
        "message": {
          "type": "string"
        },
        "error_when": {
          "type": "object"
        },
        "block_when": {
          "type": "object"
        },
        "targets": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "ui": {
          "type": "object",
          "properties": {
            "hidden_when": {
              "type": "object"
            },
            "readonly_when": {
              "type": "object"
            },
            "required_when": {
              "type": "object"
            },
            "disabled_when": {
              "type": "object"
            }
          },
          "additionalProperties": true
        },
        "backend": {
          "type": "object",
          "additionalProperties": true
        },
        "fields": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Used by required_fields rules."
        }
      },
      "additionalProperties": true
    }
  }
}
